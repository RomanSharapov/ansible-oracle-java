FROM centos:6

ENV JAVA_MAJOR 8
ENV JAVA_MINOR 121
ENV JAVA "1.$JAVA_MAJOR.0_$JAVA_MINOR"

RUN yum -y update \
    && rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm \
    && yum install -y python-pip gcc libffi-devel python-devel openssl-devel git

RUN git clone git://github.com/ansible/ansible.git --recursive /tmp/ansible

WORKDIR /tmp/ansible

RUN pip install -r ./requirements.txt \
    && git submodule update --init --recursive

ENV PATH /tmp/ansible/bin:/bin:/usr/bin:/sbin:/usr/sbin
ENV PYTHONPATH /tmp/ansible/lib
ENV ANSIBLE_LIBRARY /tmp/ansible/library

RUN mkdir -p roles

WORKDIR roles

RUN git clone https://github.com/DovnarAlexander/ansible-oracle-java.git

WORKDIR ansible-oracle-java/tests

# Syntax check
RUN ansible-playbook test.yml --syntax-check
# Lint check
RUN ansible-lint test.yml

# Run the playbook
RUN ansible-playbook test.yml --connection=local --sudo
# Idempotency check
RUN ansible-playbook test.yml --connection=local --sudo\
    | grep -q 'changed=0.*failed=0' \
    && (echo 'Idempotence test: pass' && exit 0) \
    || (echo 'Idempotence test: fail' && exit 1)

# Java version check
RUN java -version 2>&1 \
    | grep "$JAVA" \
    && (echo 'Functional test passed' && exit 0) \
    || (echo 'Functional test failed' && exit 1)
# JAVA_HOME variable check
RUN echo $JAVA_HOME \
    | grep "$JAVA" \
    && (echo 'Functional test passed' && exit 0) \
    || (echo 'Functional test failed' && exit 1)